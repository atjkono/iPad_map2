<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone GPSナビ</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {margin:0; display:flex; height:100vh; overflow:hidden; font-family:sans-serif;}
  #map {flex:1;}

  #sidebar {
    width:180px; background:#f8f8f8;
    display:flex; flex-direction:column;
    font-size:11px; overflow:hidden; transition:width .3s;
  }
  #sidebar.collapsed {width:20px;}
  #sidebar-header {
    background:#ddd; height:24px; display:flex; align-items:center;
    justify-content:space-between; padding:0 4px;
  }
  #toggle-sidebar {
    background:#444; color:white; border:none; padding:2px 5px;
    border-radius:3px; font-size:10px; cursor:pointer;
  }
  #sidebar-content {flex:1; overflow-y:auto; padding:5px;}
  input, button {width:100%; margin-top:3px; font-size:10px; padding:2px;}
  ul {list-style:none; padding:0; margin:0;}
  li {margin:2px 0; background:#e3e3e3; padding:2px; display:flex; justify-content:space-between; align-items:center;}
  li button {width:auto; margin-left:3px; padding:1px 3px; font-size:10px;}
  #navi-status {margin-top:5px; font-weight:bold; color:green; font-size:10px;}

    /* 🔵 現在地マーカー（Googleマップ風） */
    .current-location-marker {
    width: 18px;
    height: 18px;
    background: rgba(0, 122, 255, 0.9);
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(0, 122, 255, 0.9);
    }

    .current-location-marker::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <span>ルート設定</span>
    <button id="toggle-sidebar">◀</button>
  </div>

    <button id="start-navi">▶ NAVI開始</button>
    <button id="stop-navi" disabled>■ NAVI終了</button>

  <!-- 🔍 地名・住所検索欄 -->
  <div id="search-container" style="padding:4px; border-bottom:1px solid #ccc;">
    <input type="text" id="place-input" placeholder="地名・住所を入力" />
    <button id="place-search">検索</button>
  </div>

  <div id="sidebar-content">

    <p>地図をクリックして地点を追加</p>
    <h4>スタート地点</h4>
    <label><input type="radio" name="start-mode" value="gps" checked> 現在地</label><br>
    <label><input type="radio" name="start-mode" value="firstpoint"> ポイント1</label>

    <h4>地点リスト</h4>
    <ul id="point-list"></ul>

    <!-- ✅ ラジオボタン追加 -->
    <div style="margin-top:5px;">
    <label><input type="radio" name="mode" value="route" checked>ルート</label>
    <label><input type="radio" name="mode" value="point">ポイント</label>
    </div>

    <button id="clear-all">すべてクリア</button>
    <button id="save-route">ルート保存</button>
    <button id="load-route">ルート読み込み</button>
    <input type="file" id="file-input" accept=".json" style="display:none;">

    <!-- ✅ ポイント保存・読み込み追加 -->
    <button id="save-points">ポイント保存</button>
    <button id="load-points">ポイント読み込み</button>
    <input type="file" id="file-points" accept=".json" style="display:none;">
    <div id="navi-status"></div>

    <h4>ルート情報</h4>
    <div>距離: <span id="route-distance">--</span> km</div>
    <div>時間: <span id="route-time">--</span> 分</div>

    <label>ガソリン単価 (円/L): 
    <input type="number" id="fuel-price" placeholder="例: 180" min="1" step="1">
    </label><br>    

    <label>燃費 (km/L): 
    <input type="number" id="fuel-efficiency" placeholder="例: 15" min="1" step="0.1">
    </label>

    <div>金額: <span id="route-cost">--</span> 円</div>

    <button id="toggle-toll">🚗 有料道路料金</button>

  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<script>
/* --- 初期化 --- */
let map = L.map("map").setView([35.681236,139.767125],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let points = [];
let routeLine = L.polyline([], {color:"blue"}).addTo(map);
let currentMarker = null;
let startMode = "gps";
let useToll = false;
let naviWatchId = null;
let initWatchId = null;
let isNavigating = false;

const pointList = document.getElementById("point-list");
const naviStatus = document.getElementById("navi-status");
const routeDistance = document.getElementById("route-distance");
const routeTime = document.getElementById("route-time");
const routeCost = document.getElementById("route-cost");

/* --- ルート／ポイント モード切替 --- */
let mode = "route";  // ← 初期状態をルートモードに
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener("change", e=>{
    mode = e.target.value;
    naviStatus.textContent = `モード: ${mode === "route" ? "ルート" : "ポイント"}`;
  });
});

/* --- イベント設定 --- */
document.querySelectorAll('input[name="start-mode"]').forEach(r=>{
  r.addEventListener("change",e=>{
    startMode = e.target.value;
    drawRoute();
  });
});

map.on("click", e=>{
  if(mode === "route"){
    addPoint(e.latlng);
  }else if(mode === "point"){
    addSinglePoint(e.latlng);
  }
});

function addPoint(latlng){
  const i = points.length;
  const name = `地点${i+1}`;
  const mk = L.marker(latlng, {
    icon: L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"})
  }).addTo(map);

  mk.bindPopup(`
    <b>${name}</b><br>
    <button class="edit-btn" data-idx="${i}">✏️編集</button>
    <button class="del-btn" data-idx="${i}">🗑削除</button>
  `);
  points.push({lat:latlng.lat, lng:latlng.lng, name, marker:mk, type:"route"});
  updateList(); drawRoute();
}

function addSinglePoint(latlng) {
  const i = points.length;
  const name = `ポイント${i + 1}`;
  const mk = L.marker(latlng, {
    icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" })
  }).addTo(map);

  const popupHtml = `
    <b>${name}</b><br>
    <button class="edit-btn" data-idx="${i}">✏️編集</button>
    <button class="del-btn" data-idx="${i}">🗑削除</button>
  `;
  mk.bindPopup(popupHtml);

  // 🟡 hoverで吹き出し表示
  //mk.on("mouseover", () => mk.openPopup());
  //mk.on("mouseout", () => mk.closePopup());

  points.push({
    lat: latlng.lat,
    lng: latlng.lng,
    name,
    comment: "",
    image: "",
    marker: mk,
    type: "point"
  });
  updateList();
  naviStatus.textContent = "ポイントを追加しました";
}

function removePoint(i){
  if(points[i]){
    map.removeLayer(points[i].marker);
    points.splice(i,1);
    updateList(); drawRoute();
  }
}

function updateList(){
  pointList.innerHTML="";
  points.forEach((pt,i)=>{
    const li=document.createElement("li");
    const nameSpan=document.createElement("span");
    nameSpan.textContent=`${pt.name} (${pt.lat.toFixed(4)},${pt.lng.toFixed(4)})`;
    nameSpan.style.cursor="pointer";
    nameSpan.onclick = () => {
    // 地図上のマーカーを開く
    pt.marker.openPopup();
    };
    li.appendChild(nameSpan);
    pointList.appendChild(li);
  });
}

// --- ポップアップ内ボタン動作設定 ---
map.on("popupopen", e => {
  const container = e.popup.getElement();
  const editBtn = container.querySelector(".edit-btn");
  const delBtn = container.querySelector(".del-btn");

    if (editBtn) {
    editBtn.onclick = (ev) => {
        // ✅ クリックイベントを完全に遮断（これを最初に書く）
        L.DomEvent.stopPropagation(ev);
        ev.preventDefault();

        const idx = parseInt(editBtn.dataset.idx);
        const pt = points[idx];
        if (!pt) return;  // ✅ 安全対策

        if (pt.type === "route") {
        const newName = prompt("新しい地点名を入力", pt.name);
        if (newName) {
            pt.name = newName.trim();
            pt.marker.setPopupContent(`
            <b>${pt.name}</b><br>
            <button class="edit-btn" data-idx="${idx}">✏️編集</button>
            <button class="del-btn" data-idx="${idx}">🗑削除</button>
            `);
            updateList();
            map.closePopup();
        }
        } else if (pt.type === "point") {
        // 🔴 ポイント編集フォーム
        const formHtml = `
            <div style="font-size:11px;">
            名称: <input id="edit-name" value="${pt.name}" style="width:100%;"><br>
            コメント:<br>
            <textarea id="edit-comment" style="width:100%;height:40px;">${pt.comment || ""}</textarea><br>
            画像: <input type="file" id="edit-image" accept="image/*"><br>
            <button id="save-edit">保存</button>
            </div>
        `;
        pt.marker.setPopupContent(formHtml);
        setTimeout(() => {
            const saveBtn = document.getElementById("save-edit");
            saveBtn.onclick = (e2) => {
            L.DomEvent.stopPropagation(e2);
            e2.preventDefault();

            pt.name = document.getElementById("edit-name").value.trim();
            pt.comment = document.getElementById("edit-comment").value.trim();
            const fileInput = document.getElementById("edit-image");
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = ev => {
                pt.image = ev.target.result;
                updatePointPopup(pt, idx);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                updatePointPopup(pt, idx);
            }
            };
        }, 100);
        }
    };
    }

    if (delBtn) {
    delBtn.onclick = (ev) => {
        // ✅ 削除も同様にクリックイベントを遮断
        L.DomEvent.stopPropagation(ev);
        ev.preventDefault();

        const idx = parseInt(delBtn.dataset.idx);
        removePoint(idx);
        map.closePopup();
    };
    }

});

// ✅ ポイントの吹き出し更新関数
function updatePointPopup(pt, idx) {
  let popupHtml = `<b>${pt.name}</b><br>`;
  if (pt.comment) popupHtml += `<div>${pt.comment}</div>`;
  
  if (pt.image) {
    popupHtml += `
      <img src="${pt.image}" width="120" style="margin-top:4px;cursor:pointer;border-radius:4px;"
        onclick="openImageInNewTab('${pt.image}')"><br>
    `;
  }

  popupHtml += `
    <button class="edit-btn" data-idx="${idx}">✏️編集</button>
    <button class="del-btn" data-idx="${idx}">🗑削除</button>
  `;

  pt.marker.bindPopup(popupHtml);
  updateList();
}

/* --- ルート描画 --- */
async function drawRoute(){
  routeLine.setLatLngs([]);
  routeDistance.textContent="--";
  routeTime.textContent="--";
  routeCost.textContent="--";
  const routePoints = points.filter(p=>p.type==="route");
  if(routePoints.length===0)return;

  let start=null;

  if(startMode==="gps"){
    if(!currentMarker){
      naviStatus.textContent="現在地未取得";
      return; // ← 現在地がまだならルート生成しない
    }
    start=currentMarker.getLatLng();
  }else{
    start={lat:points[0].lat,lng:points[0].lng};
  }

  // ✅ ルート生成条件分岐を改良
  let allPoints;
  if(startMode==="gps"){
    allPoints=[[start.lat,start.lng],...routePoints.map(p=>[p.lat,p.lng])];
  }else{
    allPoints=routePoints.map(p=>[p.lat,p.lng]);
  }

  // ✅ 地点1つだけのときの特別処理
  if(allPoints.length < 2){
    naviStatus.textContent = "ルート生成には2点以上必要です";
    return;
  }

  // ここから先は従来通り
  const coordStr=allPoints.map(p=>`${p[1]},${p[0]}`).join(";");
  const url=`https://router.project-osrm.org/route/v1/driving/${coordStr}?geometries=geojson&overview=full`;

  try{
    const res=await fetch(url);
    if(!res.ok)throw new Error("ルート取得失敗");
    const data=await res.json();
    if(!data.routes||data.routes.length===0){alert("ルートなし");return;}

    const route=data.routes[0];
    const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
    routeLine.setLatLngs(coords);
    map.fitBounds(routeLine.getBounds());
    map.invalidateSize();

    const distKm=(route.distance/1000).toFixed(2);
    let timeMin=Math.round(route.duration/60);

    // ガソリン代計算部分はそのままOK
    const fuelEffInput=document.getElementById("fuel-efficiency");
    const fuelPriceInput=document.getElementById("fuel-price");
    const fuelEff=parseFloat(fuelEffInput.value);
    const fuelPrice=parseFloat(fuelPriceInput.value);

    let cost="--";
    if(!isNaN(fuelEff)&&fuelEff>0&&!isNaN(fuelPrice)&&fuelPrice>0){
      const fuelUsed=distKm/fuelEff;
      cost=Math.round(fuelUsed*fuelPrice);
    }

    routeDistance.textContent=distKm;
    routeTime.textContent=timeMin;
    routeCost.textContent=cost==="--"?"--":cost.toLocaleString();

    fuelEffInput.addEventListener("input",()=>drawRoute());
    fuelPriceInput.addEventListener("input",()=>drawRoute());

    naviStatus.textContent="ルート更新完了";
  }catch(e){
    console.error(e);
    alert("ルート取得エラー："+e.message);
  }
}

/* --- ボタン群 --- */
document.getElementById("clear-all").addEventListener("click",()=>{
  points.forEach(p=>map.removeLayer(p.marker));
  points=[]; routeLine.setLatLngs([]);
  updateList(); naviStatus.textContent="全クリア";
});

document.getElementById("save-route").addEventListener("click",()=>{
  if(points.length===0){alert("保存データなし");return;}
  const routePoints = points.filter(p=>p.type==="route");
  const data = routePoints.map(p=>({
    lat: p.lat,
    lng: p.lng,
    name: p.name,
    type: p.type  // ✅ ← この行を追加！
  }));
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "route.json";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("ルートを保存しました");
});

document.getElementById("load-route").addEventListener("click",()=>{
  document.getElementById("file-input").click();
});

document.getElementById("file-input").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);

      // 既存マーカー削除
      points.forEach(p => map.removeLayer(p.marker));
      points = [];

      data.forEach((p, i) => {
        const mk = L.marker([p.lat, p.lng], {
          icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" })
        }).addTo(map).bindPopup(p.name || `地点${i + 1}`);

        mk.on("click", () => removePoint(i));

        // ✅ type:"route" を付けて登録
        points.push({
          lat: p.lat,
          lng: p.lng,
          name: p.name || `地点${i + 1}`,
          marker: mk,
          type: "route"
        });
      });

      updateList();
      drawRoute(); // ここでルート再描画
      alert("ルート読み込み完了");
    } catch (err) {
      alert("読み込み失敗：" + err.message);
    }
  };
  reader.readAsText(file);
});

/* --- 有料優先切替 --- */
document.getElementById("toggle-toll").addEventListener("click", () => {
  if (points.length === 0) {
    alert("地点を追加してください。");
    return;
  }

  // ✅ すべての地点の座標を取得
  let allPoints = [];

  if (points.length === 1) {
    // 現在地と1地点
    if (!currentMarker) {
      alert("現在地が取得できません。");
      return;
    }
    const current = currentMarker.getLatLng();
    allPoints = [
      [current.lat, current.lng],
      [points[0].lat, points[0].lng]
    ];
  } else {
    // 複数地点
    const routePoints = points.filter(p=>p.type==="route");
    allPoints = routePoints.map(p => [p.lat, p.lng]);
  }

  // ✅ 地点が10個以上のときは、最初・最後＋等間隔9点
  let selectedPoints;
  if (allPoints.length > 10) {
    selectedPoints = [];
    const step = (allPoints.length - 1) / 9; // 最初と最後を含め10点
    for (let i = 0; i < 10; i++) {
      const idx = Math.round(i * step);
      selectedPoints.push(allPoints[Math.min(idx, allPoints.length - 1)]);
    }
  } else {
    selectedPoints = allPoints;
  }

  // ✅ GoogleマップのURL作成
  const gmapUrl = "https://www.google.com/maps/dir/" +
    selectedPoints.map(p => `${p[0]},${p[1]}`).join("/") + "/";

  // ✅ Googleマップで開く
  window.open(gmapUrl, "_blank");
});

/* --- NAVI開始／終了 --- */
const startBtn = document.getElementById("start-navi");
const stopBtn = document.getElementById("stop-navi");

function getCurrentLocationOnce(callback){
  if(!navigator.geolocation){
    alert("GPS未対応です");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("現在地");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    if(callback)callback(latitude,longitude);
  },err=>{
    alert("現在地を取得できません："+err.message);
  },{enableHighAccuracy:true});
}

startBtn.addEventListener("click",()=>{getCurrentLocationOnce(()=>drawRoute());
  if(isNavigating){return;}
  if(!navigator.geolocation){alert("GPS未対応");return;}
  naviStatus.textContent = "📡 NAVI開始：位置情報取得中...";
  isNavigating = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;

  naviWatchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude,accuracy} = pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("現在地");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    map.setView([latitude,longitude]);
    naviStatus.textContent=`🚗 移動中: ${latitude.toFixed(5)}, ${longitude.toFixed(5)} ±${accuracy.toFixed(1)}m`;
  },err=>{
    naviStatus.textContent="GPSエラー: "+err.message;
  },{enableHighAccuracy:true});
});

stopBtn.addEventListener("click",()=>{
  if(naviWatchId){
    navigator.geolocation.clearWatch(naviWatchId);
    naviWatchId=null;
  }
  isNavigating=false;
  startBtn.disabled=false;
  stopBtn.disabled=true;
  naviStatus.textContent="■ NAVI終了";
});

/* --- 初期位置追跡 --- */
if(navigator.geolocation){
  initWatchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("現在地");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    if(startMode==="gps")drawRoute();
  },err=>console.error(err),{enableHighAccuracy:true});
}else{
  alert("位置情報未対応ブラウザ");
}

/* --- サイドバー折りたたみ --- */
const sidebar=document.getElementById("sidebar");
const toggleBtn=document.getElementById("toggle-sidebar");
toggleBtn.onclick=()=>{
  sidebar.classList.toggle("collapsed");
  toggleBtn.textContent=sidebar.classList.contains("collapsed")?"▶":"◀";
  setTimeout(()=>map.invalidateSize(),310);
};

/* --- 🔍 地名・住所検索機能 --- */
const placeInput = document.getElementById("place-input");
const placeSearchBtn = document.getElementById("place-search");
let searchMarker = null;

placeSearchBtn.addEventListener("click", async () => {
  const query = placeInput.value.trim();
  if (!query) {
    alert("検索キーワードを入力してください。");
    return;
  }

  // Nominatim API（OpenStreetMap）を使って地名検索
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
  try {
    const res = await fetch(url, { headers: { "User-Agent": "LeafletSearchApp/1.0" }});
    const data = await res.json();

    if (data.length === 0) {
      alert("該当する場所が見つかりませんでした。");
      return;
    }

    const { lat, lon, display_name } = data[0];
    const latNum = parseFloat(lat);
    const lonNum = parseFloat(lon);

    // 既存マーカー削除
    if (searchMarker) map.removeLayer(searchMarker);

    // 新しいマーカーを追加
    searchMarker = L.marker([latNum, lonNum], {
      icon: L.icon({
        iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      })
    }).addTo(map).bindPopup(
      `<b>${display_name}</b><br><button id="add-from-search">＋ポイントに追加</button>`
    ).openPopup();

    // 地図を移動
    map.setView([latNum, lonNum], 16);

    // ✅ ポップアップボタン押下で地点追加
    setTimeout(() => {
      const btn = document.getElementById("add-from-search");
      if (btn) {
        btn.addEventListener("click", () => {
          addPoint({ lat: latNum, lng: lonNum });
          map.closePopup();
        });
      }
    }, 200);

  } catch (e) {
    console.error(e);
    alert("検索エラー：" + e.message);
  }
});

// Enterキーでも検索できるように
placeInput.addEventListener("keypress", e => {
  if (e.key === "Enter") placeSearchBtn.click();
});

// ✅ ポイント保存
document.getElementById("save-points").addEventListener("click",()=>{
  const pointData = points.filter(p=>p.type==="point").map(p=>({
    lat: p.lat,
    lng: p.lng,
    name: p.name,
    comment: p.comment || "",
    image: p.image || "" // ← ★ Base64画像データを含めて保存
  }));

  if(pointData.length===0){ alert("保存するポイントがありません"); return; }

  const blob = new Blob([JSON.stringify(pointData,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "points.json";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("ポイントを保存しました");
});

// ✅ ポイント読み込みボタン押下時にファイル選択を開く
document.getElementById("load-points").addEventListener("click", () => {
  document.getElementById("file-points").click();
});

// ✅ ポイント読み込み
document.getElementById("file-points").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      data.forEach((p, i) => {
        const mk = L.marker([p.lat, p.lng], {
          icon: L.icon({
            iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"
          })
        }).addTo(map);

        // ポイント情報を配列に追加
        const pt = {
          lat: p.lat,
          lng: p.lng,
          name: p.name || `地点${i + 1}`,
          comment: p.comment || "",
          image: p.image || "",
          marker: mk,
          type: p.type || "point"
        };
        points.push(pt);

        // ✅ ポップアップを確実に設定（ここが重要！）
        updatePointPopup(pt, points.length - 1);
      });

      updateList();
      alert("ポイント読み込み完了");
    } catch (err) {
      alert("読み込み失敗：" + err.message);
    }
  };
  reader.readAsText(file);
});


/* --- ✅ Google My MapsのKMLを読み込む --- */
const loadKmlBtn = document.createElement("button");
loadKmlBtn.textContent = "Googleルート読み込み(KML)";
document.getElementById("sidebar-content").appendChild(loadKmlBtn);

const kmlInput = document.createElement("input");
kmlInput.type = "file";
kmlInput.accept = ".kml";
kmlInput.style.display = "none";
document.getElementById("sidebar-content").appendChild(kmlInput);

loadKmlBtn.addEventListener("click", () => kmlInput.click());

/* --- ✅ KMLルート保存ボタンを追加 --- */
const saveKmlBtn = document.createElement("button");
saveKmlBtn.textContent = "KMLルート保存";
document.getElementById("sidebar-content").appendChild(saveKmlBtn);

saveKmlBtn.addEventListener("click", () => {
  const routePoints = points.filter(p => p.type === "route");
  if (routePoints.length < 2) {
    alert("ルートを作成してください（2点以上必要）");
    return;
  }

  // KML構造を生成
  const coords = routePoints.map(p => `${p.lng},${p.lat},0`).join(" ");
  const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>Leafletルート出力</name>
      <Placemark>
        <name>ルート</name>
        <LineString>
          <tessellate>1</tessellate>
          <coordinates>${coords}</coordinates>
        </LineString>
      </Placemark>
    </Document>
  </kml>`;

  // ダウンロード処理
  const blob = new Blob([kmlContent], { type: "application/vnd.google-earth.kml+xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "route.kml";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("KMLファイルを保存しました");
});

kmlInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(ev.target.result, "text/xml");
    const coords = Array.from(xml.getElementsByTagName("coordinates"));
    if (coords.length === 0) {
      alert("KMLファイルにルート座標が見つかりません");
      return;
    }

    // KML内の座標を抽出
    const allCoords = [];
    coords.forEach(cnode => {
      const lines = cnode.textContent.trim().split(/\s+/);
      lines.forEach(line => {
        const [lng, lat] = line.split(",").map(Number);
        if (!isNaN(lat) && !isNaN(lng)) {
          allCoords.push({ lat, lng });
        }
      });
    });

    if (allCoords.length === 0) {
      alert("座標が読み取れません");
      return;
    }

    // 既存ルートをクリア
    points.forEach(p => map.removeLayer(p.marker));
    points = [];

    // ルート上にマーカーを追加
    allCoords.forEach((p, i) => {
      const mk = L.marker([p.lat, p.lng], {
        icon: L.icon({
          iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"
        })
      }).addTo(map).bindPopup(`地点${i + 1}`);
      points.push({ lat: p.lat, lng: p.lng, name: `地点${i + 1}`, marker: mk, type: "route" });
    });

    drawRoute();
    alert(`Googleマップのルート(${allCoords.length}点)を読み込みました`);
  };
  reader.readAsText(file);
});

// 🔍 別タブに拡大画像を開く関数
function openImageInNewTab(url) {
  const newTab = window.open("", "_blank");
  if (!newTab) {
    alert("ポップアップがブロックされました。ブラウザの設定を確認してください。");
    return;
  }

  newTab.document.write(`
    <html>
      <head>
        <title>画像ビューア</title>
        <style>
          body {
            margin: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            font-family: sans-serif;
          }
          .img-box {
            position: relative;
            display: inline-block;
          }
          img {
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
          }
          .buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
          }
          button, a {
            background: #333;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
          }
          button:hover, a:hover {
            background: #555;
          }
        </style>
      </head>
      <body>
        <div class="img-box">
          <img src="${url}" alt="拡大画像">
        </div>
        <div class="buttons">
          <a href="${url}" download target="_blank">💾 ダウンロード</a>
          <button onclick="window.close()">✖ 閉じる</button>
        </div>
      </body>
    </html>
  `);
  newTab.document.close();
}

/* --- ページ読込時に現在地を自動追跡 --- */
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;
    if (!currentMarker) {
      currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
          className: "current-location-marker",
          iconSize: [18, 18],
          iconAnchor: [9, 9]
        })
      }).addTo(map).bindPopup("現在地");
      map.setView([latitude, longitude], 15);
    } else {
      currentMarker.setLatLng([latitude, longitude]);
    }
    if (startMode === "gps") drawRoute();
  }, err => {
    console.error("GPS初期化エラー:", err);
  }, { enableHighAccuracy: true });
}

</script>
</body>
</html>
