<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone GPSãƒŠãƒ“</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {margin:0; display:flex; height:100vh; overflow:hidden; font-family:sans-serif;}
  #map {flex:1;}

  #sidebar {
    width:180px; background:#f8f8f8;
    display:flex; flex-direction:column;
    font-size:11px; overflow:hidden; transition:width .3s;
  }
  #sidebar.collapsed {width:20px;}
  #sidebar-header {
    background:#ddd; height:24px; display:flex; align-items:center;
    justify-content:space-between; padding:0 4px;
  }
  #toggle-sidebar {
    background:#444; color:white; border:none; padding:2px 5px;
    border-radius:3px; font-size:10px; cursor:pointer;
  }
  #sidebar-content {flex:1; overflow-y:auto; padding:5px;}
  input, button {width:100%; margin-top:3px; font-size:10px; padding:2px;}
  ul {list-style:none; padding:0; margin:0;}
  li {margin:2px 0; background:#e3e3e3; padding:2px; display:flex; justify-content:space-between; align-items:center;}
  li button {width:auto; margin-left:3px; padding:1px 3px; font-size:10px;}
  #navi-status {margin-top:5px; font-weight:bold; color:green; font-size:10px;}

    /* ğŸ”µ ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆGoogleãƒãƒƒãƒ—é¢¨ï¼‰ */
    .current-location-marker {
    width: 18px;
    height: 18px;
    background: rgba(0, 122, 255, 0.9);
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(0, 122, 255, 0.9);
    }

    .current-location-marker::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <span>ãƒ«ãƒ¼ãƒˆè¨­å®š</span>
    <button id="toggle-sidebar">â—€</button>
  </div>

    <button id="start-navi">â–¶ NAVIé–‹å§‹</button>
    <button id="stop-navi" disabled>â–  NAVIçµ‚äº†</button>

  <!-- ğŸ” åœ°åãƒ»ä½æ‰€æ¤œç´¢æ¬„ -->
  <div id="search-container" style="padding:4px; border-bottom:1px solid #ccc;">
    <input type="text" id="place-input" placeholder="åœ°åãƒ»ä½æ‰€ã‚’å…¥åŠ›" />
    <button id="place-search">æ¤œç´¢</button>
  </div>

  <div id="sidebar-content">

    <p>åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’è¿½åŠ </p>
    <h4>ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹</h4>
    <label><input type="radio" name="start-mode" value="gps" checked> ç¾åœ¨åœ°</label><br>
    <label><input type="radio" name="start-mode" value="firstpoint"> ãƒã‚¤ãƒ³ãƒˆ1</label>

    <h4>åœ°ç‚¹ãƒªã‚¹ãƒˆ</h4>
    <ul id="point-list"></ul>

    <!-- âœ… ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³è¿½åŠ  -->
    <div style="margin-top:5px;">
    <label><input type="radio" name="mode" value="route" checked>ãƒ«ãƒ¼ãƒˆ</label>
    <label><input type="radio" name="mode" value="point">ãƒã‚¤ãƒ³ãƒˆ</label>
    </div>

    <button id="clear-all">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
    <button id="save-route">ãƒ«ãƒ¼ãƒˆä¿å­˜</button>
    <button id="load-route">ãƒ«ãƒ¼ãƒˆèª­ã¿è¾¼ã¿</button>
    <input type="file" id="file-input" accept=".json" style="display:none;">

    <!-- âœ… ãƒã‚¤ãƒ³ãƒˆä¿å­˜ãƒ»èª­ã¿è¾¼ã¿è¿½åŠ  -->
    <button id="save-points">ãƒã‚¤ãƒ³ãƒˆä¿å­˜</button>
    <button id="load-points">ãƒã‚¤ãƒ³ãƒˆèª­ã¿è¾¼ã¿</button>
    <input type="file" id="file-points" accept=".json" style="display:none;">
    <div id="navi-status"></div>

    <h4>ãƒ«ãƒ¼ãƒˆæƒ…å ±</h4>
    <div>è·é›¢: <span id="route-distance">--</span> km</div>
    <div>æ™‚é–“: <span id="route-time">--</span> åˆ†</div>

    <label>ã‚¬ã‚½ãƒªãƒ³å˜ä¾¡ (å††/L): 
    <input type="number" id="fuel-price" placeholder="ä¾‹: 180" min="1" step="1">
    </label><br>    

    <label>ç‡ƒè²» (km/L): 
    <input type="number" id="fuel-efficiency" placeholder="ä¾‹: 15" min="1" step="0.1">
    </label>

    <div>é‡‘é¡: <span id="route-cost">--</span> å††</div>

    <button id="toggle-toll">ğŸš— æœ‰æ–™é“è·¯æ–™é‡‘</button>

  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<script>
/* --- åˆæœŸåŒ– --- */
let map = L.map("map").setView([35.681236,139.767125],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let points = [];
let routeLine = L.polyline([], {color:"blue"}).addTo(map);
let currentMarker = null;
let startMode = "gps";
let useToll = false;
let naviWatchId = null;
let initWatchId = null;
let isNavigating = false;

const pointList = document.getElementById("point-list");
const naviStatus = document.getElementById("navi-status");
const routeDistance = document.getElementById("route-distance");
const routeTime = document.getElementById("route-time");
const routeCost = document.getElementById("route-cost");

/* --- ãƒ«ãƒ¼ãƒˆï¼ãƒã‚¤ãƒ³ãƒˆ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ --- */
let mode = "route";  // â† åˆæœŸçŠ¶æ…‹ã‚’ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã«
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener("change", e=>{
    mode = e.target.value;
    naviStatus.textContent = `ãƒ¢ãƒ¼ãƒ‰: ${mode === "route" ? "ãƒ«ãƒ¼ãƒˆ" : "ãƒã‚¤ãƒ³ãƒˆ"}`;
  });
});

/* --- ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š --- */
document.querySelectorAll('input[name="start-mode"]').forEach(r=>{
  r.addEventListener("change",e=>{
    startMode = e.target.value;
    drawRoute();
  });
});

map.on("click", e=>{
  if(mode === "route"){
    addPoint(e.latlng);
  }else if(mode === "point"){
    addSinglePoint(e.latlng);
  }
});

function addPoint(latlng){
  const i = points.length;
  const name = `åœ°ç‚¹${i+1}`;
  const mk = L.marker(latlng, {
    icon: L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"})
  }).addTo(map);

  mk.bindPopup(`
    <b>${name}</b><br>
    <button class="edit-btn" data-idx="${i}">âœï¸ç·¨é›†</button>
    <button class="del-btn" data-idx="${i}">ğŸ—‘å‰Šé™¤</button>
  `);
  points.push({lat:latlng.lat, lng:latlng.lng, name, marker:mk, type:"route"});
  updateList(); drawRoute();
}

function addSinglePoint(latlng) {
  const i = points.length;
  const name = `ãƒã‚¤ãƒ³ãƒˆ${i + 1}`;
  const mk = L.marker(latlng, {
    icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" })
  }).addTo(map);

  const popupHtml = `
    <b>${name}</b><br>
    <button class="edit-btn" data-idx="${i}">âœï¸ç·¨é›†</button>
    <button class="del-btn" data-idx="${i}">ğŸ—‘å‰Šé™¤</button>
  `;
  mk.bindPopup(popupHtml);

  // ğŸŸ¡ hoverã§å¹ãå‡ºã—è¡¨ç¤º
  //mk.on("mouseover", () => mk.openPopup());
  //mk.on("mouseout", () => mk.closePopup());

  points.push({
    lat: latlng.lat,
    lng: latlng.lng,
    name,
    comment: "",
    image: "",
    marker: mk,
    type: "point"
  });
  updateList();
  naviStatus.textContent = "ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ";
}

function removePoint(i){
  if(points[i]){
    map.removeLayer(points[i].marker);
    points.splice(i,1);
    updateList(); drawRoute();
  }
}

function updateList(){
  pointList.innerHTML="";
  points.forEach((pt,i)=>{
    const li=document.createElement("li");
    const nameSpan=document.createElement("span");
    nameSpan.textContent=`${pt.name} (${pt.lat.toFixed(4)},${pt.lng.toFixed(4)})`;
    nameSpan.style.cursor="pointer";
    nameSpan.onclick = () => {
    // åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’é–‹ã
    pt.marker.openPopup();
    };
    li.appendChild(nameSpan);
    pointList.appendChild(li);
  });
}

// --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ãƒœã‚¿ãƒ³å‹•ä½œè¨­å®š ---
map.on("popupopen", e => {
  const container = e.popup.getElement();
  const editBtn = container.querySelector(".edit-btn");
  const delBtn = container.querySelector(".del-btn");

    if (editBtn) {
    editBtn.onclick = (ev) => {
        // âœ… ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®Œå…¨ã«é®æ–­ï¼ˆã“ã‚Œã‚’æœ€åˆã«æ›¸ãï¼‰
        L.DomEvent.stopPropagation(ev);
        ev.preventDefault();

        const idx = parseInt(editBtn.dataset.idx);
        const pt = points[idx];
        if (!pt) return;  // âœ… å®‰å…¨å¯¾ç­–

        if (pt.type === "route") {
        const newName = prompt("æ–°ã—ã„åœ°ç‚¹åã‚’å…¥åŠ›", pt.name);
        if (newName) {
            pt.name = newName.trim();
            pt.marker.setPopupContent(`
            <b>${pt.name}</b><br>
            <button class="edit-btn" data-idx="${idx}">âœï¸ç·¨é›†</button>
            <button class="del-btn" data-idx="${idx}">ğŸ—‘å‰Šé™¤</button>
            `);
            updateList();
            map.closePopup();
        }
        } else if (pt.type === "point") {
        // ğŸ”´ ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
        const formHtml = `
            <div style="font-size:11px;">
            åç§°: <input id="edit-name" value="${pt.name}" style="width:100%;"><br>
            ã‚³ãƒ¡ãƒ³ãƒˆ:<br>
            <textarea id="edit-comment" style="width:100%;height:40px;">${pt.comment || ""}</textarea><br>
            ç”»åƒ: <input type="file" id="edit-image" accept="image/*"><br>
            <button id="save-edit">ä¿å­˜</button>
            </div>
        `;
        pt.marker.setPopupContent(formHtml);
        setTimeout(() => {
            const saveBtn = document.getElementById("save-edit");
            saveBtn.onclick = (e2) => {
            L.DomEvent.stopPropagation(e2);
            e2.preventDefault();

            pt.name = document.getElementById("edit-name").value.trim();
            pt.comment = document.getElementById("edit-comment").value.trim();
            const fileInput = document.getElementById("edit-image");
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = ev => {
                pt.image = ev.target.result;
                updatePointPopup(pt, idx);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                updatePointPopup(pt, idx);
            }
            };
        }, 100);
        }
    };
    }

    if (delBtn) {
    delBtn.onclick = (ev) => {
        // âœ… å‰Šé™¤ã‚‚åŒæ§˜ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é®æ–­
        L.DomEvent.stopPropagation(ev);
        ev.preventDefault();

        const idx = parseInt(delBtn.dataset.idx);
        removePoint(idx);
        map.closePopup();
    };
    }

});

// âœ… ãƒã‚¤ãƒ³ãƒˆã®å¹ãå‡ºã—æ›´æ–°é–¢æ•°
function updatePointPopup(pt, idx) {
  let popupHtml = `<b>${pt.name}</b><br>`;
  if (pt.comment) popupHtml += `<div>${pt.comment}</div>`;
  
  if (pt.image) {
    popupHtml += `
      <img src="${pt.image}" width="120" style="margin-top:4px;cursor:pointer;border-radius:4px;"
        onclick="openImageInNewTab('${pt.image}')"><br>
    `;
  }

  popupHtml += `
    <button class="edit-btn" data-idx="${idx}">âœï¸ç·¨é›†</button>
    <button class="del-btn" data-idx="${idx}">ğŸ—‘å‰Šé™¤</button>
  `;

  pt.marker.bindPopup(popupHtml);
  updateList();
}

/* --- ãƒ«ãƒ¼ãƒˆæç”» --- */
async function drawRoute(){
  routeLine.setLatLngs([]);
  routeDistance.textContent="--";
  routeTime.textContent="--";
  routeCost.textContent="--";
  const routePoints = points.filter(p=>p.type==="route");
  if(routePoints.length===0)return;

  let start=null;

  if(startMode==="gps"){
    if(!currentMarker){
      naviStatus.textContent="ç¾åœ¨åœ°æœªå–å¾—";
      return;
    }
    start=currentMarker.getLatLng();
  }else{
    start={lat:points[0].lat,lng:points[0].lng};
  }

  let allPoints = startMode==="gps"
      ? [[start.lng, start.lat], ...routePoints.map(p => [p.lng, p.lat])]
      : routePoints.map(p => [p.lng, p.lat]);

  if(allPoints.length < 2){
    naviStatus.textContent = "ãƒ«ãƒ¼ãƒˆç”Ÿæˆã«ã¯2ç‚¹ä»¥ä¸Šå¿…è¦ã§ã™";
    return;
  }

  const coordStr = allPoints.map(p => `${p[0]},${p[1]}`).join(";");
  const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coordStr}?geometries=geojson&overview=full`;

  try {
    const res = await fetch(osrmUrl);
    if (!res.ok) throw new Error("ãƒ«ãƒ¼ãƒˆå–å¾—å¤±æ•—");

    const data = await res.json();
    if (!data.routes || data.routes.length === 0) {
      alert("ãƒ«ãƒ¼ãƒˆãªã—");
      return;
    }

    const route = data.routes[0];
    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
    routeLine.setLatLngs(coords);
    map.fitBounds(routeLine.getBounds());

    const distKm = (route.distance / 1000).toFixed(2);
    const timeMin = Math.round(route.duration / 60);

    const fuelEff = parseFloat(document.getElementById("fuel-efficiency").value);
    const fuelPrice = parseFloat(document.getElementById("fuel-price").value);
    let cost = "--";
    if(!isNaN(fuelEff) && fuelEff > 0 && !isNaN(fuelPrice) && fuelPrice > 0){
      const fuelUsed = distKm / fuelEff;
      cost = Math.round(fuelUsed * fuelPrice);
    }

    routeDistance.textContent = distKm;
    routeTime.textContent = timeMin;
    routeCost.textContent = cost === "--" ? "--" : cost.toLocaleString();
    naviStatus.textContent = "ãƒ«ãƒ¼ãƒˆæ›´æ–°å®Œäº†";
  } catch(e) {
    console.error(e);
    alert("ãƒ«ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" + e.message);
  }
}

/* --- ãƒœã‚¿ãƒ³ç¾¤ --- */
document.getElementById("clear-all").addEventListener("click",()=>{
  points.forEach(p=>map.removeLayer(p.marker));
  points=[]; routeLine.setLatLngs([]);
  updateList(); naviStatus.textContent="å…¨ã‚¯ãƒªã‚¢";
});

document.getElementById("save-route").addEventListener("click",()=>{
  if(points.length===0){alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—");return;}
  const routePoints = points.filter(p=>p.type==="route");
  const data = routePoints.map(p=>({
    lat: p.lat,
    lng: p.lng,
    name: p.name,
    type: p.type  // âœ… â† ã“ã®è¡Œã‚’è¿½åŠ ï¼
  }));
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "route.json";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("ãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

document.getElementById("load-route").addEventListener("click",()=>{
  document.getElementById("file-input").click();
});

document.getElementById("file-input").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);

      // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
      points.forEach(p => map.removeLayer(p.marker));
      points = [];

      data.forEach((p, i) => {
        const mk = L.marker([p.lat, p.lng], {
          icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" })
        }).addTo(map).bindPopup(p.name || `åœ°ç‚¹${i + 1}`);

        mk.on("click", () => removePoint(i));

        // âœ… type:"route" ã‚’ä»˜ã‘ã¦ç™»éŒ²
        points.push({
          lat: p.lat,
          lng: p.lng,
          name: p.name || `åœ°ç‚¹${i + 1}`,
          marker: mk,
          type: "route"
        });
      });

      updateList();
      drawRoute(); // ã“ã“ã§ãƒ«ãƒ¼ãƒˆå†æç”»
      alert("ãƒ«ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
    } catch (err) {
      alert("èª­ã¿è¾¼ã¿å¤±æ•—ï¼š" + err.message);
    }
  };
  reader.readAsText(file);
});

/* --- æœ‰æ–™å„ªå…ˆåˆ‡æ›¿ --- */
document.getElementById("toggle-toll").addEventListener("click", () => {
  if (points.length === 0) {
    alert("åœ°ç‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // âœ… ã™ã¹ã¦ã®åœ°ç‚¹ã®åº§æ¨™ã‚’å–å¾—
  let allPoints = [];

  if (points.length === 1) {
    // ç¾åœ¨åœ°ã¨1åœ°ç‚¹
    if (!currentMarker) {
      alert("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚");
      return;
    }
    const current = currentMarker.getLatLng();
    allPoints = [
      [current.lat, current.lng],
      [points[0].lat, points[0].lng]
    ];
  } else {
    // è¤‡æ•°åœ°ç‚¹
    const routePoints = points.filter(p=>p.type==="route");
    allPoints = routePoints.map(p => [p.lat, p.lng]);
  }

  // âœ… åœ°ç‚¹ãŒ10å€‹ä»¥ä¸Šã®ã¨ãã¯ã€æœ€åˆãƒ»æœ€å¾Œï¼‹ç­‰é–“éš”9ç‚¹
  let selectedPoints;
  if (allPoints.length > 10) {
    selectedPoints = [];
    const step = (allPoints.length - 1) / 9; // æœ€åˆã¨æœ€å¾Œã‚’å«ã‚10ç‚¹
    for (let i = 0; i < 10; i++) {
      const idx = Math.round(i * step);
      selectedPoints.push(allPoints[Math.min(idx, allPoints.length - 1)]);
    }
  } else {
    selectedPoints = allPoints;
  }

  // âœ… Googleãƒãƒƒãƒ—ã®URLä½œæˆ
  const gmapUrl = "https://www.google.com/maps/dir/" +
    selectedPoints.map(p => `${p[0]},${p[1]}`).join("/") + "/";

  // âœ… Googleãƒãƒƒãƒ—ã§é–‹ã
  window.open(gmapUrl, "_blank");
});

/* --- NAVIé–‹å§‹ï¼çµ‚äº† --- */
const startBtn = document.getElementById("start-navi");
const stopBtn = document.getElementById("stop-navi");

function getCurrentLocationOnce(callback){
  if(!navigator.geolocation){
    alert("GPSæœªå¯¾å¿œã§ã™");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("ç¾åœ¨åœ°");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    if(callback)callback(latitude,longitude);
  },err=>{
    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ï¼š"+err.message);
  },{enableHighAccuracy:true});
}

startBtn.addEventListener("click",()=>{getCurrentLocationOnce(()=>drawRoute());
  if(isNavigating){return;}
  if(!navigator.geolocation){alert("GPSæœªå¯¾å¿œ");return;}
  naviStatus.textContent = "ğŸ“¡ NAVIé–‹å§‹ï¼šä½ç½®æƒ…å ±å–å¾—ä¸­...";
  isNavigating = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;

  naviWatchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude,accuracy} = pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("ç¾åœ¨åœ°");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    map.setView([latitude,longitude]);
    naviStatus.textContent=`ğŸš— ç§»å‹•ä¸­: ${latitude.toFixed(5)}, ${longitude.toFixed(5)} Â±${accuracy.toFixed(1)}m`;
  },err=>{
    naviStatus.textContent="GPSã‚¨ãƒ©ãƒ¼: "+err.message;
  },{enableHighAccuracy:true});
});

stopBtn.addEventListener("click",()=>{
  if(naviWatchId){
    navigator.geolocation.clearWatch(naviWatchId);
    naviWatchId=null;
  }
  isNavigating=false;
  startBtn.disabled=false;
  stopBtn.disabled=true;
  naviStatus.textContent="â–  NAVIçµ‚äº†";
});

/* --- åˆæœŸä½ç½®è¿½è·¡ --- */
if(navigator.geolocation){
  initWatchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("ç¾åœ¨åœ°");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    if(startMode==="gps")drawRoute();
  },err=>console.error(err),{enableHighAccuracy:true});
}else{
  alert("ä½ç½®æƒ…å ±æœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶");
}

/* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ --- */
const sidebar=document.getElementById("sidebar");
const toggleBtn=document.getElementById("toggle-sidebar");
toggleBtn.onclick=()=>{
  sidebar.classList.toggle("collapsed");
  toggleBtn.textContent=sidebar.classList.contains("collapsed")?"â–¶":"â—€";
  setTimeout(()=>map.invalidateSize(),310);
};

/* --- ğŸ” åœ°åãƒ»ä½æ‰€æ¤œç´¢æ©Ÿèƒ½ --- */
const placeInput = document.getElementById("place-input");
const placeSearchBtn = document.getElementById("place-search");
let searchMarker = null;

placeSearchBtn.addEventListener("click", async () => {
  const query = placeInput.value.trim();
  if (!query) {
    alert("æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // Nominatim APIï¼ˆOpenStreetMapï¼‰ã‚’ä½¿ã£ã¦åœ°åæ¤œç´¢
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
  try {
    const res = await fetch(url, { headers: { "User-Agent": "LeafletSearchApp/1.0" }});
    const data = await res.json();

    if (data.length === 0) {
      alert("è©²å½“ã™ã‚‹å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }

    const { lat, lon, display_name } = data[0];
    const latNum = parseFloat(lat);
    const lonNum = parseFloat(lon);

    // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
    if (searchMarker) map.removeLayer(searchMarker);

    // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
    searchMarker = L.marker([latNum, lonNum], {
      icon: L.icon({
        iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      })
    }).addTo(map).bindPopup(
      `<b>${display_name}</b><br><button id="add-from-search">ï¼‹ãƒã‚¤ãƒ³ãƒˆã«è¿½åŠ </button>`
    ).openPopup();

    // åœ°å›³ã‚’ç§»å‹•
    map.setView([latNum, lonNum], 16);

    // âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§åœ°ç‚¹è¿½åŠ 
    setTimeout(() => {
      const btn = document.getElementById("add-from-search");
      if (btn) {
        btn.addEventListener("click", () => {
          addPoint({ lat: latNum, lng: lonNum });
          map.closePopup();
        });
      }
    }, 200);

  } catch (e) {
    console.error(e);
    alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ï¼š" + e.message);
  }
});

// Enterã‚­ãƒ¼ã§ã‚‚æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«
placeInput.addEventListener("keypress", e => {
  if (e.key === "Enter") placeSearchBtn.click();
});

// âœ… ãƒã‚¤ãƒ³ãƒˆä¿å­˜
document.getElementById("save-points").addEventListener("click",()=>{
  const pointData = points.filter(p=>p.type==="point").map(p=>({
    lat: p.lat,
    lng: p.lng,
    name: p.name,
    comment: p.comment || "",
    image: p.image || "" // â† â˜… Base64ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã¦ä¿å­˜
  }));

  if(pointData.length===0){ alert("ä¿å­˜ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); return; }

  const blob = new Blob([JSON.stringify(pointData,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "points.json";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("ãƒã‚¤ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

// âœ… ãƒã‚¤ãƒ³ãƒˆèª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’é–‹ã
document.getElementById("load-points").addEventListener("click", () => {
  document.getElementById("file-points").click();
});

// âœ… ãƒã‚¤ãƒ³ãƒˆèª­ã¿è¾¼ã¿
document.getElementById("file-points").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      data.forEach((p, i) => {
        const mk = L.marker([p.lat, p.lng], {
          icon: L.icon({
            iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"
          })
        }).addTo(map);

        // ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã‚’é…åˆ—ã«è¿½åŠ 
        const pt = {
          lat: p.lat,
          lng: p.lng,
          name: p.name || `åœ°ç‚¹${i + 1}`,
          comment: p.comment || "",
          image: p.image || "",
          marker: mk,
          type: p.type || "point"
        };
        points.push(pt);

        // âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ç¢ºå®Ÿã«è¨­å®šï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
        updatePointPopup(pt, points.length - 1);
      });

      updateList();
      alert("ãƒã‚¤ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
    } catch (err) {
      alert("èª­ã¿è¾¼ã¿å¤±æ•—ï¼š" + err.message);
    }
  };
  reader.readAsText(file);
});


/* --- âœ… Google My Mapsã®KMLã‚’èª­ã¿è¾¼ã‚€ --- */
const loadKmlBtn = document.createElement("button");
loadKmlBtn.textContent = "Googleãƒ«ãƒ¼ãƒˆèª­ã¿è¾¼ã¿(KML)";
document.getElementById("sidebar-content").appendChild(loadKmlBtn);

const kmlInput = document.createElement("input");
kmlInput.type = "file";
kmlInput.accept = ".kml";
kmlInput.style.display = "none";
document.getElementById("sidebar-content").appendChild(kmlInput);

loadKmlBtn.addEventListener("click", () => kmlInput.click());

/* --- âœ… KMLãƒ«ãƒ¼ãƒˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  --- */
const saveKmlBtn = document.createElement("button");
saveKmlBtn.textContent = "KMLãƒ«ãƒ¼ãƒˆä¿å­˜";
document.getElementById("sidebar-content").appendChild(saveKmlBtn);

saveKmlBtn.addEventListener("click", () => {
  const routePoints = points.filter(p => p.type === "route");
  if (routePoints.length < 2) {
    alert("ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼ˆ2ç‚¹ä»¥ä¸Šå¿…è¦ï¼‰");
    return;
  }

  // KMLæ§‹é€ ã‚’ç”Ÿæˆ
  const coords = routePoints.map(p => `${p.lng},${p.lat},0`).join(" ");
  const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>Leafletãƒ«ãƒ¼ãƒˆå‡ºåŠ›</name>
      <Placemark>
        <name>ãƒ«ãƒ¼ãƒˆ</name>
        <LineString>
          <tessellate>1</tessellate>
          <coordinates>${coords}</coordinates>
        </LineString>
      </Placemark>
    </Document>
  </kml>`;

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
  const blob = new Blob([kmlContent], { type: "application/vnd.google-earth.kml+xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "route.kml";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("KMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

kmlInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(ev.target.result, "text/xml");
    const coords = Array.from(xml.getElementsByTagName("coordinates"));
    if (coords.length === 0) {
      alert("KMLãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ«ãƒ¼ãƒˆåº§æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    // KMLå†…ã®åº§æ¨™ã‚’æŠ½å‡º
    const allCoords = [];
    coords.forEach(cnode => {
      const lines = cnode.textContent.trim().split(/\s+/);
      lines.forEach(line => {
        const [lng, lat] = line.split(",").map(Number);
        if (!isNaN(lat) && !isNaN(lng)) {
          allCoords.push({ lat, lng });
        }
      });
    });

    if (allCoords.length === 0) {
      alert("åº§æ¨™ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“");
      return;
    }

    // æ—¢å­˜ãƒ«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
    points.forEach(p => map.removeLayer(p.marker));
    points = [];

    // ãƒ«ãƒ¼ãƒˆä¸Šã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
    allCoords.forEach((p, i) => {
      const mk = L.marker([p.lat, p.lng], {
        icon: L.icon({
          iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"
        })
      }).addTo(map).bindPopup(`åœ°ç‚¹${i + 1}`);
      points.push({ lat: p.lat, lng: p.lng, name: `åœ°ç‚¹${i + 1}`, marker: mk, type: "route" });
    });

    drawRoute();
    alert(`Googleãƒãƒƒãƒ—ã®ãƒ«ãƒ¼ãƒˆ(${allCoords.length}ç‚¹)ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  };
  reader.readAsText(file);
});

// ğŸ” åˆ¥ã‚¿ãƒ–ã«æ‹¡å¤§ç”»åƒã‚’é–‹ãé–¢æ•°
function openImageInNewTab(url) {
  const newTab = window.open("", "_blank");
  if (!newTab) {
    alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  newTab.document.write(`
    <html>
      <head>
        <title>ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢</title>
        <style>
          body {
            margin: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            font-family: sans-serif;
          }
          .img-box {
            position: relative;
            display: inline-block;
          }
          img {
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
          }
          .buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
          }
          button, a {
            background: #333;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
          }
          button:hover, a:hover {
            background: #555;
          }
        </style>
      </head>
      <body>
        <div class="img-box">
          <img src="${url}" alt="æ‹¡å¤§ç”»åƒ">
        </div>
        <div class="buttons">
          <a href="${url}" download target="_blank">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
          <button onclick="window.close()">âœ– é–‰ã˜ã‚‹</button>
        </div>
      </body>
    </html>
  `);
  newTab.document.close();
}

/* --- ãƒšãƒ¼ã‚¸èª­è¾¼æ™‚ã«ç¾åœ¨åœ°ã‚’è‡ªå‹•è¿½è·¡ --- */
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;
    if (!currentMarker) {
      currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
          className: "current-location-marker",
          iconSize: [18, 18],
          iconAnchor: [9, 9]
        })
      }).addTo(map).bindPopup("ç¾åœ¨åœ°");
      map.setView([latitude, longitude], 15);
    } else {
      currentMarker.setLatLng([latitude, longitude]);
    }
    if (startMode === "gps") drawRoute();
  }, err => {
    console.error("GPSåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
  }, { enableHighAccuracy: true });
}

</script>
</body>
</html>
