<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone GPSナビ</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {margin:0; display:flex; height:100vh; overflow:hidden; font-family:sans-serif;}
  #map {flex:1;}

  #sidebar {
    width:180px; background:#f8f8f8;
    display:flex; flex-direction:column;
    font-size:11px; overflow:hidden; transition:width .3s;
  }
  #sidebar.collapsed {width:20px;}
  #sidebar-header {
    background:#ddd; height:24px; display:flex; align-items:center;
    justify-content:space-between; padding:0 4px;
  }
  #toggle-sidebar {
    background:#444; color:white; border:none; padding:2px 5px;
    border-radius:3px; font-size:10px; cursor:pointer;
  }
  #sidebar-content {flex:1; overflow-y:auto; padding:5px;}
  input, button {width:100%; margin-top:3px; font-size:10px; padding:2px;}
  ul {list-style:none; padding:0; margin:0;}
  li {margin:2px 0; background:#e3e3e3; padding:2px; display:flex; justify-content:space-between; align-items:center;}
  li button {width:auto; margin-left:3px; padding:1px 3px; font-size:10px;}
  #navi-status {margin-top:5px; font-weight:bold; color:green; font-size:10px;}

    /* 🔵 現在地マーカー（Googleマップ風） */
    .current-location-marker {
    width: 18px;
    height: 18px;
    background: rgba(0, 122, 255, 0.9);
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(0, 122, 255, 0.9);
    }

    .current-location-marker::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <span>ルート設定</span>
    <button id="toggle-sidebar">◀</button>
  </div>

    <button id="start-navi">▶ NAVI開始</button>
    <button id="stop-navi" disabled>■ NAVI終了</button>

  <!-- 🔍 地名・住所検索欄 -->
  <div id="search-container" style="padding:4px; border-bottom:1px solid #ccc;">
    <input type="text" id="place-input" placeholder="地名・住所を入力" />
    <button id="place-search">検索</button>
    <button id="reset-search">リセット</button>
  </div>

  <div id="search-results" style="padding:4px; font-size:10px;"></div>

  <div id="sidebar-content">

    <p>地図をクリックして地点を追加</p>
    <h4>スタート地点</h4>
    <label><input type="radio" name="start-mode" value="gps" checked> 現在地</label><br>
    <label><input type="radio" name="start-mode" value="firstpoint"> ポイント1</label>

    <h4>地点リスト</h4>
    <ul id="point-list"></ul>

    <!-- ✅ ラジオボタン追加 -->
    <div style="margin-top:5px;">
    <label><input type="radio" name="mode" value="route" checked>ルート</label>
    <label><input type="radio" name="mode" value="point">ポイント</label>
    </div>

    <button id="clear-all">すべてクリア</button>
    <button id="clear-part">部分クリア</button> 
    <button id="load-json">json読み込み</button>
    <button id="save-json">jsonルート保存</button>
    <input type="file" id="file-json" accept=".json" style="display:none;">
    <div id="navi-status"></div>

    <button id="load-kml">KML読み込み</button>
    <input type="file" id="file-kml" accept=".kml" style="display:none;">
    <button id="save-kml">KMLルート保存</button>

    <h4>ルート情報</h4>
    <div>距離: <span id="route-distance">--</span> km</div>
    <div>時間: <span id="route-time">--</span> 分</div>

    <label>ガソリン単価 (円/L): 
    <input type="number" id="fuel-price" placeholder="例: 180" min="1" step="1">
    </label><br>    

    <label>燃費 (km/L): 
    <input type="number" id="fuel-efficiency" placeholder="例: 15" min="1" step="0.1">
    </label>

    <div>金額: <span id="route-cost">--</span> 円</div>

    <button id="toggle-toll">🚗 有料道路料金</button>

  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<script>
/* --- 初期化 --- */
let map = L.map("map").setView([35.681236,139.767125],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let points = [];
let routeLine = L.polyline([], {color:"blue"}).addTo(map);
let currentMarker = null;
let startMode = "gps";
let useToll = false;
let naviWatchId = null;
let initWatchId = null;
let isNavigating = false;

const pointList = document.getElementById("point-list");
const naviStatus = document.getElementById("navi-status");
const routeDistance = document.getElementById("route-distance");
const routeTime = document.getElementById("route-time");
const routeCost = document.getElementById("route-cost");

/* --- ルート／ポイント モード切替 --- */
let mode = "route";  // ← 初期状態をルートモードに
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener("change", e=>{
    mode = e.target.value;
    naviStatus.textContent = `モード: ${mode === "route" ? "ルート" : "ポイント"}`;
  });
});

/* --- イベント設定 --- */
document.querySelectorAll('input[name="start-mode"]').forEach(r=>{
  r.addEventListener("change",e=>{
    startMode = e.target.value;
    drawRoute();
  });
});

map.on("click", e=>{
  if(mode === "route"){
    addPoint(e.latlng);
  }else if(mode === "point"){
    addSinglePoint(e.latlng);
  }
});

function addPoint(latlng){
  const i = points.length;
  const name = `地点${i+1}`;
  const mk = L.marker(latlng, {
    icon: L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"})
  }).addTo(map);

  mk.bindPopup(`
    <b>${name}</b><br>
    <button class="edit-btn" data-idx="${i}">✏️編集</button>
    <button class="del-btn" data-idx="${i}">🗑削除</button>
  `);
  points.push({lat:latlng.lat, lng:latlng.lng, name, marker:mk, type:"route"});
  updateList(); drawRoute();
}

function addSinglePoint(latlng) {
  const i = points.length;
  const name = `ポイント${i + 1}`;
  const mk = L.marker(latlng, {
    icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" })
  }).addTo(map);

  const popupHtml = `
    <b>${name}</b><br>
    <button class="edit-btn" data-idx="${i}">✏️編集</button>
    <button class="del-btn" data-idx="${i}">🗑削除</button>
  `;
  mk.bindPopup(popupHtml);

  // 🟡 hoverで吹き出し表示
  //mk.on("mouseover", () => mk.openPopup());
  //mk.on("mouseout", () => mk.closePopup());

  points.push({
    lat: latlng.lat,
    lng: latlng.lng,
    name,
    comment: "",
    image: "",
    marker: mk,
    type: "point"
  });
  updateList();
  naviStatus.textContent = "ポイントを追加しました";
}

function removePoint(i){
  if(points[i]){
    map.removeLayer(points[i].marker);
    points.splice(i,1);
    updateList(); drawRoute();
  }
}

function updateList(){
  pointList.innerHTML="";
  points.forEach((pt,i)=>{
    const li=document.createElement("li");
    const nameSpan=document.createElement("span");
    nameSpan.textContent=`${pt.name} (${pt.lat.toFixed(4)},${pt.lng.toFixed(4)})`;
    nameSpan.style.cursor="pointer";
    nameSpan.onclick = () => {
    // 地図上のマーカーを開く
    pt.marker.openPopup();
    };
    li.appendChild(nameSpan);
    pointList.appendChild(li);
  });
}

// --- ポップアップ内ボタン動作設定 ---
map.on("popupopen", e => {
  const container = e.popup.getElement();
  const editBtn = container.querySelector(".edit-btn");
  const delBtn = container.querySelector(".del-btn");

    if (editBtn) {
    editBtn.onclick = (ev) => {
        // ✅ クリックイベントを完全に遮断（これを最初に書く）
        L.DomEvent.stopPropagation(ev);
        ev.preventDefault();

        const idx = parseInt(editBtn.dataset.idx);
        const pt = points[idx];
        if (!pt) return;  // ✅ 安全対策

        if (pt.type === "route") {
        const newName = prompt("新しい地点名を入力", pt.name);
        if (newName) {
            pt.name = newName.trim();
            pt.marker.setPopupContent(`
            <b>${pt.name}</b><br>
            <button class="edit-btn" data-idx="${idx}">✏️編集</button>
            <button class="del-btn" data-idx="${idx}">🗑削除</button>
            `);
            updateList();
            map.closePopup();
        }
        } else if (pt.type === "point") {
        // 🔴 ポイント編集フォーム
        const formHtml = `
            <div style="font-size:11px;">
            名称: <input id="edit-name" value="${pt.name}" style="width:100%;"><br>
            コメント:<br>
            <textarea id="edit-comment" style="width:100%;height:40px;">${pt.comment || ""}</textarea><br>
            画像: <input type="file" id="edit-image" accept="image/*"><br>
            <button id="save-edit">保存</button>
            </div>
        `;
        pt.marker.setPopupContent(formHtml);
        setTimeout(() => {
            const saveBtn = document.getElementById("save-edit");
            saveBtn.onclick = (e2) => {
            L.DomEvent.stopPropagation(e2);
            e2.preventDefault();

            pt.name = document.getElementById("edit-name").value.trim();
            pt.comment = document.getElementById("edit-comment").value.trim();
            const fileInput = document.getElementById("edit-image");
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = ev => {
                pt.image = ev.target.result;
                updatePointPopup(pt, idx);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                updatePointPopup(pt, idx);
            }
            };
        }, 100);
        }
    };
    }

    if (delBtn) {
    delBtn.onclick = (ev) => {
        // ✅ 削除も同様にクリックイベントを遮断
        L.DomEvent.stopPropagation(ev);
        ev.preventDefault();

        const idx = parseInt(delBtn.dataset.idx);
        removePoint(idx);
        map.closePopup();
    };
    }

});

// ✅ ポイントの吹き出し更新関数
function updatePointPopup(pt, idx) {
  let popupHtml = `<b>${pt.name}</b><br>`;
  if (pt.comment) popupHtml += `<div>${pt.comment}</div>`;
  
  if (pt.image) {
    popupHtml += `
      <img src="${pt.image}" width="120" style="margin-top:4px;cursor:pointer;border-radius:4px;"
        onclick="openImageInNewTab('${pt.image}')"><br>
    `;
  }

  popupHtml += `
    <button class="edit-btn" data-idx="${idx}">✏️編集</button>
    <button class="del-btn" data-idx="${idx}">🗑削除</button>
  `;

  pt.marker.bindPopup(popupHtml);
  updateList();
}

/* --- ルート描画 --- */
async function drawRoute(){
  routeLine.setLatLngs([]);
  routeDistance.textContent="--";
  routeTime.textContent="--";
  routeCost.textContent="--";
  const routePoints = points.filter(p=>p.type==="route");
  if(routePoints.length===0)return;

  let start = null;

  if (startMode === "gps") {
    if (!currentMarker) {
      naviStatus.textContent = "現在地未取得";
      return;
    }
    start = currentMarker.getLatLng();
  } else if (startMode === "firstpoint") {
// 残っているルートポイントの最初のものをスタートに
    const firstRoute = points.find(p => p.type === "route");
    if (!firstRoute) {
      naviStatus.textContent = "ルートの最初のポイントがありません";
      return;
    }
    start = { lat: firstRoute.lat, lng: firstRoute.lng };
  }

  let allPoints = startMode==="gps"
      ? [[start.lng, start.lat], ...routePoints.map(p => [p.lng, p.lat])]
      : routePoints.map(p => [p.lng, p.lat]);

  if(allPoints.length < 2){
    naviStatus.textContent = "ルート生成には2点以上必要です";
    return;
  }

  const coordStr = allPoints.map(p => `${p[0]},${p[1]}`).join(";");
  //const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coordStr}?geometries=geojson&overview=full`;
  const osrmUrl = `https://routing.openstreetmap.de/routed-car/route/v1/driving/${coordStr}?overview=full&geometries=geojson`;

    try {
    async function safeFetch(url, timeout = 8000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);

        try {
        const res = await fetch(url, { signal: controller.signal, mode: "cors" });
        clearTimeout(id);
        if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
        return res;
        } catch (err) {
        clearTimeout(id);
        if (err.name === "AbortError") {
            throw new Error("タイムアウトしました（通信遅延）");
        } else {
            throw new Error("通信エラー（CORSまたはネットワーク）");
        }
        }
    }

    // ✅ safeFetch()を実行してレスポンスを受け取る
    const res = await safeFetch(osrmUrl);
    const data = await res.json();
    if (!data.routes || data.routes.length === 0) {
      alert("ルート情報が取得できませんでした");
      return;
    }

    const route = data.routes[0];
    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
    routeLine.setLatLngs(coords);
    map.fitBounds(routeLine.getBounds());

    const distKm = (route.distance / 1000).toFixed(2);
    const timeMin = Math.round(route.duration / 60);

    // 燃費と費用計算
    const fuelEff = parseFloat(document.getElementById("fuel-efficiency").value);
    const fuelPrice = parseFloat(document.getElementById("fuel-price").value);
    let cost = "--";
    if (!isNaN(fuelEff) && fuelEff > 0 && !isNaN(fuelPrice) && fuelPrice > 0) {
      const fuelUsed = distKm / fuelEff;
      cost = Math.round(fuelUsed * fuelPrice);
    }

    routeDistance.textContent = distKm;
    routeTime.textContent = timeMin;
    routeCost.textContent = cost === "--" ? "--" : cost.toLocaleString();
    naviStatus.textContent = "ルート更新完了";

  } catch(e) {
    console.error(e);
    alert("ルート取得エラー：" + e.message);
  }
}

/* --- ボタン群 --- */
document.getElementById("clear-all").addEventListener("click",()=>{
  points.forEach(p=>map.removeLayer(p.marker));
  points=[]; routeLine.setLatLngs([]);
  updateList(); naviStatus.textContent="全クリア";
});

document.getElementById("clear-part").addEventListener("click", () => {
  const selectedMode = document.querySelector('input[name="mode"]:checked')?.value || "route";

  // 選択されたタイプを削除
  points = points.filter(p => {
    if (p.type === selectedMode) {
      map.removeLayer(p.marker);
      return false;
    }
    return true;
  });

  // 残っているルートを再描画
  // ポイントのみ削除でもルートは残して再描画
  if (points.some(p => p.type === "route")) {
    drawRoute();
  } else {
    routeLine.setLatLngs([]);
  }

  updateList();
  naviStatus.textContent = `${selectedMode === "route" ? "ルート" : "ポイント"}のみクリアしました`;
});

// ✅ 「ルート読み込み」もモード対応に変更
// ✅ jsonルート保存（ルート＋ポイント両方まとめて保存）
document.getElementById("save-json").addEventListener("click", () => {
  if (points.length === 0) {
    alert("保存データがありません");
    return;
  }

  const data = {
    route: points.filter(p => p.type === "route").map(p => ({
      lat: p.lat, lng: p.lng, name: p.name
    })),
    points: points.filter(p => p.type === "point").map(p => ({
      lat: p.lat, lng: p.lng, name: p.name,
      comment: p.comment || "", image: p.image || ""
    }))
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mapdata.json";
  a.click();
  URL.revokeObjectURL(a.href);
  alert("ルートとポイントを保存しました");
});

// ✅ json読み込み（ルート＋ポイント復元・現在のモードで色変更）
document.getElementById("load-json").addEventListener("click", () => {
  const fileInput = document.getElementById("file-json");
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const data = JSON.parse(ev.target.result);
      points.forEach(p => map.removeLayer(p.marker));
      points = [];

      // ✅ 現在のモード（ルート or ポイント）を取得
      const currentMode = document.querySelector('input[name="mode"]:checked')?.value || "route";
      const markerIconUrl = currentMode === "route"
        ? "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"
        : "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png";

      // ✅ ルート＋ポイント問わず共通で扱う
      const allPoints = [
        ...(data.route || []),
        ...(data.points || [])
      ];

      allPoints.forEach((p, i) => {
        const mk = L.marker([p.lat, p.lng], {
          icon: L.icon({ iconUrl: markerIconUrl })
        }).addTo(map);

        let popupHtml = `<b>${p.name}</b><br>`;
        if (p.comment) popupHtml += `<div>${p.comment}</div>`;
        if (p.image) {
          popupHtml += `<img src="${p.image}" width="120" style="margin-top:4px;border-radius:4px;"><br>`;
        }
        popupHtml += `
          <button class="edit-btn" data-idx="${points.length}">✏️編集</button>
          <button class="del-btn" data-idx="${points.length}">🗑削除</button>`;

        mk.bindPopup(popupHtml);

        // ✅ typeを現在モードに統一
        points.push({ ...p, marker: mk, type: currentMode });
      });

      updateList();
      if (currentMode === "route") drawRoute();
      alert(`jsonファイルを${currentMode === "route" ? "ルート" : "ポイント"}として読み込みました`);
    };
    reader.readAsText(file);
    e.target.value = "";
  };
  fileInput.click();
});

document.getElementById("load-kml").addEventListener("click", () => {
  document.getElementById("file-kml").click();
});

document.getElementById("file-kml").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(ev.target.result, "text/xml");
    const placemarks = Array.from(xml.getElementsByTagName("Placemark"));
    if (placemarks.length === 0) return alert("KMLにPlacemarkがありません。");

    mode = document.querySelector('input[name="mode"]:checked')?.value || mode;

    points.forEach(p => map.removeLayer(p.marker));
    points = [];

    placemarks.forEach(pm => {
      const coordsTag = pm.getElementsByTagName("coordinates")[0];
      if (!coordsTag) return;

      const nameTag = pm.getElementsByTagName("name")[0];
      const descTag = pm.getElementsByTagName("description")[0];
      const name = nameTag ? nameTag.textContent.trim() : "名称なし";

      // ---------- description の「中身（HTML 文字列）」を正しく取得 ----------
        let descHtml = "";
        if (descTag) {
        // XML の子ノードをシリアライズして「中身の文字列」を再構成する（CDATA / HTML を壊さない）
        const serializer = new XMLSerializer();
        descHtml = Array.from(descTag.childNodes)
            .map(n => serializer.serializeToString(n))
            .join("")
            .trim();

        // CDATAを含むdescriptionを正しく取得
        descHtml = descTag.textContent.trim();

        // DOMParserでHTMLとして解析
        const htmlDoc = new DOMParser().parseFromString(descHtml, "text/html");
        const img = htmlDoc.querySelector("img");
        const imageUrl = img ? img.src : "";
        const commentText = htmlDoc.body.innerText.trim();
        }

        // ---------- HTML として解析して、画像 URL とテキストコメントを分離 ----------
      let commentText = "";
      let imageUrl = "";
      if (descHtml) {
        try {
          // ブラウザの DOMParser を使い HTML としてパース
          const htmlParser = new DOMParser();
          const doc = htmlParser.parseFromString(descHtml, "text/html");
          // 最初の img を取得（なければ空）
          const img = doc.querySelector("img");
          if (img && img.src) {
            imageUrl = img.getAttribute("src");
          }
          // コメント部分は body のテキスト（画像タグは無視される）
          commentText = doc.body ? doc.body.innerText.trim() : "";
          // もし commentText が空で且つ descHtml がタグ無しテキストならそれを使う
          if (!commentText && descHtml && !descHtml.match(/<\w+/)) {
            commentText = descHtml;
          }
        } catch (err) {
          // パース失敗でも生のテキストを fallback
          commentText = descHtml.replace(/<img[\s\S]*?>/i, "").replace(/<!\[CDATA\[|\]\]>/g, "").trim();
        }
      }

      // 座標の取り出し（LineString か Point のどちらでも対応）
      const coordText = coordsTag.textContent.trim();
      const coordPairs = coordText.split(/\s+/).map(c => {
        const [lng, lat] = c.split(",").map(Number);
        return [lat, lng];
      });

      // ラインを描画（ルートなら線）
      L.polyline(coordPairs, { color: (mode === "route" ? "blue" : "red"), weight: 4 }).addTo(map);

      // 各座標にマーカーを作る
      coordPairs.forEach((latlng, i) => {
        const mk = L.marker(latlng, {
          icon: L.icon({
            iconUrl:
              mode === "route"
                ? "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"
                : "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"
          })
        }).addTo(map);

        // ポップアップに comment と 画像 を反映（画像はクリックで拡大）
        let popupHtml = `<b>${name} ${i + 1}</b><br>`;
        if (commentText) popupHtml += `<div>${commentText}</div>`;
        if (imageUrl) {
          popupHtml += `<img src="${imageUrl}" width="120" style="margin-top:4px;border-radius:4px;cursor:pointer;" onclick="openImageInNewTab('${imageUrl}')"><br>`;
        }
        popupHtml += `
          <button class="edit-btn" data-idx="${points.length}">✏️編集</button>
          <button class="del-btn" data-idx="${points.length}">🗑削除</button>
        `;
        mk.bindPopup(popupHtml);

        points.push({
          lat: latlng[0],
          lng: latlng[1],
          name: `${name} ${i + 1}`,
          comment: commentText,
          image: imageUrl,
          marker: mk,
          type: mode
        });
      });
    });

    updateList();
    if (mode === "route") {
      drawRoute();
    }
    alert(`KML${mode === "route" ? "ルート" : "ポイント"}読み込み完了`);
  };
  reader.readAsText(file);
});

// 🔽 KMLルート保存機能を追加
document.getElementById("save-kml").addEventListener("click", () => {
  const routePoints = points.filter(p => p.type === "route");
  const pointPoints = points.filter(p => p.type === "point");

  if (routePoints.length === 0 && pointPoints.length === 0) {
    alert("保存するデータがありません");
    return;
  }

  let kml =
    '<?xml version="1.0" encoding="UTF-8"?>\n' +
    '<kml xmlns="http://www.opengis.net/kml/2.2">\n' +
    '<Document>\n';

  // 🔵 ルート線を追加
  if (routePoints.length > 0) {
    kml += '<Placemark>\n<name>ルート</name>\n<LineString>\n<coordinates>\n';
    routePoints.forEach(p => {
      kml += `${p.lng},${p.lat},0\n`;
    });
    kml += '</coordinates>\n</LineString>\n</Placemark>\n';
  }

  // 🔴 ポイントを追加
pointPoints.forEach(p => {
  // 名前は基本的にエスケープしておく
  const safeName = (p.name || "").replace(/[&<>]/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[s]));

  // description 部分は HTML をそのまま埋め込むため CDATA を使う
  // comment と image を組み合わせる（image は <img src="..."> の形）
  let descHtml = "";
  if (p.comment) {
    // 改行を <br> に変換して見た目を保つ
    descHtml += `${p.comment.replace(/\n/g, "<br>")}`;
  }
    if (p.image) {
    // Base64形式の場合は画像を別ファイルに書き出し、KML内では相対パス参照にする
    // 例: images/point1.jpg など
    const imgFilename = `${p.name.replace(/[\\/:*?"<>|]/g, "_")}.jpg`;
    descHtml += `<br><img src="images/${imgFilename}" width="300" />`;

    // 後で画像ファイルも生成（ここではKMLだけ出力する場合はスキップ可能）
    }

    kml +=
    `<Placemark>\n` +
    `<name>${safeName}</name>\n` +
    `<description><![CDATA[${descHtml}]]></description>\n` +
    `<Point><coordinates>${p.lng},${p.lat},0</coordinates></Point>\n` +
    `</Placemark>\n`;
});

  kml += '</Document>\n</kml>';

  const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mapdata.kml";
  a.click();
  URL.revokeObjectURL(a.href);

  let msg = [];
  if (routePoints.length > 0) msg.push("ルート");
  if (pointPoints.length > 0) msg.push("ポイント");
  alert(`KML(${msg.join("＋")})を保存しました`);
});


/* --- 有料優先切替 --- */
document.getElementById("toggle-toll").addEventListener("click", () => {
  if (points.length === 0) {
    alert("地点を追加してください。");
    return;
  }

  // ✅ すべての地点の座標を取得
  let allPoints = [];

  if (points.length === 1) {
    // 現在地と1地点
    if (!currentMarker) {
      alert("現在地が取得できません。");
      return;
    }
    const current = currentMarker.getLatLng();
    allPoints = [
      [current.lat, current.lng],
      [points[0].lat, points[0].lng]
    ];
  } else {
    // 複数地点
    const routePoints = points.filter(p=>p.type==="route");
    allPoints = routePoints.map(p => [p.lat, p.lng]);
  }

  // ✅ 地点が10個以上のときは、最初・最後＋等間隔9点
  let selectedPoints;
  if (allPoints.length > 10) {
    selectedPoints = [];
    const step = (allPoints.length - 1) / 9; // 最初と最後を含め10点
    for (let i = 0; i < 10; i++) {
      const idx = Math.round(i * step);
      selectedPoints.push(allPoints[Math.min(idx, allPoints.length - 1)]);
    }
  } else {
    selectedPoints = allPoints;
  }

  // ✅ GoogleマップのURL作成
  const gmapUrl = "https://www.google.com/maps/dir/" +
    selectedPoints.map(p => `${p[0]},${p[1]}`).join("/") + "/";

  // ✅ Googleマップで開く
  window.open(gmapUrl, "_blank");
});

/* --- NAVI開始／終了 --- */
const startBtn = document.getElementById("start-navi");
const stopBtn = document.getElementById("stop-navi");

function getCurrentLocationOnce(callback){
  if(!navigator.geolocation){
    alert("GPS未対応です");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("現在地");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    if(callback)callback(latitude,longitude);
  },err=>{
    alert("現在地を取得できません："+err.message);
  },{enableHighAccuracy:true});
}

startBtn.addEventListener("click",()=>{getCurrentLocationOnce(()=>drawRoute());
  if(isNavigating){return;}
  if(!navigator.geolocation){alert("GPS未対応");return;}
  naviStatus.textContent = "📡 NAVI開始：位置情報取得中...";
  isNavigating = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;

  naviWatchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude,accuracy} = pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("現在地");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    map.setView([latitude,longitude]);
    naviStatus.textContent=`🚗 移動中: ${latitude.toFixed(5)}, ${longitude.toFixed(5)} ±${accuracy.toFixed(1)}m`;
  },err=>{
    naviStatus.textContent="GPSエラー: "+err.message;
  },{enableHighAccuracy:true});
});

stopBtn.addEventListener("click",()=>{
  if(naviWatchId){
    navigator.geolocation.clearWatch(naviWatchId);
    naviWatchId=null;
  }
  isNavigating=false;
  startBtn.disabled=false;
  stopBtn.disabled=true;
  naviStatus.textContent="■ NAVI終了";
});

/* --- 初期位置追跡 --- */
if(navigator.geolocation){
  initWatchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!currentMarker){
    currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
        className: "current-location-marker",
        iconSize: [18, 18],
        iconAnchor: [9, 9]
        })
    }).addTo(map).bindPopup("現在地");
    map.setView([latitude, longitude], 15);
    } else {
    currentMarker.setLatLng([latitude, longitude]);
    }
    if(startMode==="gps")drawRoute();
  },err=>console.error(err),{enableHighAccuracy:true});
}else{
  alert("位置情報未対応ブラウザ");
}

/* --- サイドバー折りたたみ --- */
const sidebar=document.getElementById("sidebar");
const toggleBtn=document.getElementById("toggle-sidebar");
toggleBtn.onclick=()=>{
  sidebar.classList.toggle("collapsed");
  toggleBtn.textContent=sidebar.classList.contains("collapsed")?"▶":"◀";
  setTimeout(()=>map.invalidateSize(),310);
};

/* --- 🔍 地名・住所検索機能 --- */
const placeInput = document.getElementById("place-input");
const placeSearchBtn = document.getElementById("place-search");
let searchMarker = null;

placeSearchBtn.addEventListener("click", async () => {
  const query = placeInput.value.trim();
  if (!query) {
    alert("検索キーワードを入力してください。");
    return;
  }

  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
  try {
    const res = await fetch(url, { headers: { "User-Agent": "LeafletSearchApp/1.0" }});
    if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
    const data = await res.json();

    if (data.length === 0) {
      naviStatus.textContent = "検索結果なし";
      return;
    }

    const { lat, lon, display_name } = data[0];
    const latNum = parseFloat(lat);
    const lonNum = parseFloat(lon);

    if (searchMarker) map.removeLayer(searchMarker);

    searchMarker = L.marker([latNum, lonNum], {
      icon: L.icon({
        iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
        iconSize: [32,32], iconAnchor: [16,32],
      })
    }).addTo(map).bindPopup(`<b>${display_name}</b><br><button id="add-from-search">＋ポイントに追加</button>`).openPopup();

    map.setView([latNum, lonNum], 16);

    setTimeout(() => {
      const btn = document.getElementById("add-from-search");
      if (btn) btn.addEventListener("click", () => {
        addPoint({ lat: latNum, lng: lonNum });
        map.closePopup();
      });
    }, 200);

    naviStatus.textContent = `検索成功: ${display_name}`;

  } catch (e) {
    console.error(e);
    naviStatus.textContent = "検索エラー: ネットワークまたはCORSの問題";
  }
});

// Enterキーでも検索できるように
placeInput.addEventListener("keypress", e => {
  if (e.key === "Enter") placeSearchBtn.click();
});

document.getElementById("file-kml").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = "";
  const reader = new FileReader();
  reader.onload = ev => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(ev.target.result, "text/xml");
    const coords = Array.from(xml.getElementsByTagName("coordinates"));
    if (coords.length === 0) {
      alert("KMLファイルにルート座標が見つかりません");
      return;
    }

    // KML座標の処理...
  };
  reader.readAsText(file);
});

// 🔍 別タブに拡大画像を開く関数
function openImageInNewTab(url) {
  const newTab = window.open("", "_blank");
  if (!newTab) {
    alert("ポップアップがブロックされました。ブラウザの設定を確認してください。");
    return;
  }

  newTab.document.write(`
    <html>
      <head>
        <title>画像ビューア</title>
        <style>
          body {
            margin: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            font-family: sans-serif;
          }
          .img-box {
            position: relative;
            display: inline-block;
          }
          img {
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
          }
          .buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
          }
          button, a {
            background: #333;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
          }
          button:hover, a:hover {
            background: #555;
          }
        </style>
      </head>
      <body>
        <div class="img-box">
          <img src="${url}" alt="拡大画像">
        </div>
        <div class="buttons">
          <a href="${url}" download target="_blank">💾 ダウンロード</a>
          <button onclick="window.close()">✖ 閉じる</button>
        </div>
      </body>
    </html>
  `);
  newTab.document.close();
}

/* --- ページ読込時に現在地を自動追跡 --- */
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;
    if (!currentMarker) {
      currentMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
          className: "current-location-marker",
          iconSize: [18, 18],
          iconAnchor: [9, 9]
        })
      }).addTo(map).bindPopup("現在地");
      map.setView([latitude, longitude], 15);
    } else {
      currentMarker.setLatLng([latitude, longitude]);
    }
    if (startMode === "gps") drawRoute();
  }, err => {
    console.error("GPS初期化エラー:", err);
  }, { enableHighAccuracy: true });
}

/* --- 🔍 住所・地名検索機能 --- */
// 🔍 検索ボタンの動作（例: Nominatim APIを使う想定）
document.getElementById("place-search").addEventListener("click", async () => {
  const query = document.getElementById("place-input").value.trim();
  const resultDiv = document.getElementById("search-results");

  if (!query) {
    alert("地名または住所を入力してください");
    return;
  }

  resultDiv.innerHTML = "検索中...";

  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
    const data = await res.json();

    if (data.length === 0) {
      resultDiv.innerHTML = "該当する場所が見つかりません。";
      return;
    }

    // 🔽 検索結果一覧を生成
    resultDiv.innerHTML = "<b>検索結果:</b><br><ul>";
    data.forEach((loc, i) => {
      const lat = parseFloat(loc.lat);
      const lon = parseFloat(loc.lon);
      const name = loc.display_name;
      resultDiv.innerHTML += `
        <li>
          <span style="cursor:pointer;color:blue;" onclick="moveToResult(${lat},${lon},'${name.replace(/'/g,"")}')">
            ${name}
          </span>
        </li>`;
    });
    resultDiv.innerHTML += "</ul>";

  } catch (err) {
    resultDiv.innerHTML = "検索エラーが発生しました";
    console.error(err);
  }
});

// 🔹 検索結果クリック時に地図移動
function moveToResult(lat, lon, name) {
  map.setView([lat, lon], 16);
  L.marker([lat, lon]).addTo(map)
    .bindPopup(`<b>${name}</b>`)
    .openPopup();
}

// 🔁 リセットボタン（検索窓 + 結果一覧の両方をクリア）
document.getElementById("reset-search").addEventListener("click", () => {
  document.getElementById("place-input").value = "";
  document.getElementById("search-results").innerHTML = "";
  naviStatus.textContent = "検索リセットしました";
});


</script>
</body>
</html>
